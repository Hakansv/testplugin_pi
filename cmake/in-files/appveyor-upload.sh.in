#!/usr/bin/env bash

#
# Upload the .tar.gz and .xml artifacts to cloudsmith
#
set -xe

STABLE_REPO='@CLOUDSMITH_USER@/@GIT_REPOSITORY_NAME@-stable'
UNSTABLE_REPO='@CLOUDSMITH_USER@/@GIT_REPOSITORY_NAME@'

#git_head=$(git rev-parse master) || git_head="unknown"
#if [ "$git_head" != "$(git rev-parse HEAD)" ]; then
#    echo "Not on master branch, skipping deployment."
#    exit 0
#fi

set +x
if [ -z "$CLOUDSMITH_API_KEY" ]; then
    echo 'Cannot deploy to cloudsmith, missing $CLOUDSMITH_API_KEY'
    exit 0
fi
set -x

echo "Using \$CLOUDSMITH_API_KEY: ${CLOUDSMITH_API_KEY:0:4}..."

commit=$(git rev-parse --short=7 HEAD) || commit="unknown"
now=$(date --rfc-3339=seconds) || now=$(date)

BUILD_ID=${APPVEYOR_BUILD_NUMBER:-1}
commit=$(git rev-parse --short=7 HEAD) || commit="unknown"
tag=$(git tag --contains HEAD)

tarball=$(ls *.tar.gz)
xml=$(ls *.xml)

source ../build/pkg_version.sh
test -n "$tag" && VERSION="$tag" || VERSION="${VERSION}+${BUILD_ID}.${commit}"
test -n "$tag" && REPO="$STABLE_REPO" || REPO="$UNSTABLE_REPO"

cat $xml

if [ -n "$tag" ]; then
    # There is no sed available in git bash. This is nasty, but seems
    # to work:
    echo 'substituting xmal file stuff'
    while read line; do
        line=${line//--pkg_repo--/$REPO}
        line=${line//--name--/$tarball_name}
        line=${line//--version--/$VERSION}
        line=${line//--filename--/$tarball_basename}
        echo $line
    done < $xml > xml.tmp && cat xml.tmp && cp xml.tmp $xml && rm xml.tmp
fi

cat $xml

cloudsmith push raw \
    --republish \
    --no-wait-for-sync \
    --name @PACKAGE@-@PKG_TARGET@-@PKG_TARGET_VERSION@-metadata \
    --version ${VERSION} \
    --summary "@PACKAGE@ opencpn plugin metadata for automatic installation" \
    $REPO $xml

cloudsmith push raw  \
    --republish \
    --no-wait-for-sync \
    --name @PACKAGE@-@PKG_TARGET@-@PKG_TARGET_VERSION@-tarball \
    --version ${VERSION} \
    --summary "@PACKAGE@ opencpn plugin tarball for automatic installation" \
    $REPO $tarball
